{% extends 'base.html' %}
{% block title %}Risk Assessment - DengueTect{% endblock %}
{% block content %}
  <h2 class="page-title">Risk Assessment</h2>

  {% set colors = {'low':'green', 'moderate':'orange', 'high':'red'} %}
  {% set color = colors.get(current_risk, 'gray') %}

  <div class="card center">
    <h3 class="card-title">Current Risk: <span class="badge {{ color }}">{{ current_risk|capitalize }} Risk</span></h3>
    {% if enhanced_percentage is defined %}
      <p class="muted">Enhanced comprehensive assessment: {{ enhanced_percentage }}% risk ({{ enhanced_risk_level|replace('_', ' ')|title }})</p>
      {% if bite_adjustment is defined and bite_adjustment > 0 %}
        <p class="muted">Bite analysis adjustment: +{{ bite_adjustment }}%{% if bite_label %} ({{ bite_label }}){% endif %}{% if analysis_id %} · <a href="/bite-analysis-result?aid={{ analysis_id }}">view analysis</a>{% endif %}</p>
      {% endif %}
    {% endif %}
    <p class="muted">Primary estimate (used for Current Risk): published model calibrated to your context. Warning signs can escalate the label regardless of %.</p>

    <div class="circle">
      <svg viewBox="0 0 36 36">
        <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
        {% if enhanced_percentage is defined %}
          <path class="fg {{ color }}" stroke-dasharray="{{ enhanced_percentage }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
        {% else %}
          <path class="fg {{ color }}" stroke-dasharray="{{ prob_pct }}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
        {% endif %}
      </svg>
      <div class="circle-center {{ color }}">
        {% if enhanced_percentage is defined %}
          {{ enhanced_percentage }}%
        {% else %}
          {{ prob_pct }}%
        {% endif %}
      </div>
    </div>

    {% if current_risk == 'low' %}
      <p class="text">The bite and symptoms show minimal signs of dengue infection. Continue monitoring your condition and practice standard mosquito prevention.</p>
    {% elif current_risk == 'moderate' %}
      <p class="text">Some signs suggest the possibility of dengue infection. Monitor your symptoms closely over the next 24-48 hours. If new symptoms appear or worsen, consider seeking medical advice.</p>
    {% elif current_risk == 'high' %}
      <p class="text">There is a strong indication of potential dengue infection. You are advised to seek medical attention, especially if you experience fever, severe headache, or body pain.</p>
    {% endif %}
  </div>

  <div class="card">
    <h3 class="card-title">Risk Breakdown</h3>
    {% if enhanced_percentage is defined and calc.breakdown is defined %}
      <div class="progress-row">
        <span>Enhanced comprehensive assessment</span>
        <div class="bar"><span class="bar-fill {{ color }}" style="width: {{ enhanced_percentage }}%"></span></div>
        <span class="pct {{ color }}">{{ enhanced_percentage }}%</span>
      </div>
      <p class="muted" style="margin-top:8px">
        <strong>Symptom Category Breakdown:</strong>
      </p>
      <ul class="ref-list">
        <li>Core symptoms weight: <strong>{{ calc.breakdown.core_symptoms }}</strong> ({{ calc.breakdown.symptom_counts.core }} symptoms)</li>
        <li>Warning signs weight: <strong>{{ calc.breakdown.warning_signs }}</strong> ({{ calc.breakdown.symptom_counts.warning }} symptoms)</li>
        <li>Additional features weight: <strong>{{ calc.breakdown.additional_features }}</strong> ({{ calc.breakdown.symptom_counts.additional }} symptoms)</li>
        <li>Total weight: <strong>{{ calc.breakdown.total_weight }}</strong></li>
        <li>Base percentage: <strong>{{ calc.breakdown.base_percentage }}%</strong></li>
        <li>Multiplier applied: <strong>{{ calc.breakdown.multiplier }}</strong></li>
      </ul>
    {% endif %}
    <div class="progress-row">
      <span>Original model probability</span>
      <div class="bar"><span class="bar-fill {{ color }}" style="width: {{ prob_pct }}%"></span></div>
      <span class="pct {{ color }}">{{ prob_pct }}%</span>
    </div>
    <p class="muted" style="margin-top:8px">
      Predictors used by this model: petechiae (+), retro-ocular pain (+), gingival bleeding (+), epistaxis (−), skin paleness (−). Selecting symptoms outside these five will not change the model probability, but they may affect the displayed risk label via WHO/CDC warning signs.
    </p>
    <p class="muted">
      Positive predictors present: <strong>{{ calc.inputs.petechiae + calc.inputs.retro_ocular_pain + calc.inputs.gingival_bleeding }}/3</strong>
      &nbsp;•&nbsp; Negative predictors present: <strong>{{ calc.inputs.epistaxis + calc.inputs.skin_paleness }}/2</strong>
    </p>
  </div>

  <details class="card">
    <summary><span class="card-title"><strong>Why are there different numbers? See alternative estimates</strong></span></summary>
    <div class="stack" style="margin-top:8px">
      <h3 class="card-title">Compare Estimates</h3>
      <div class="progress-row">
        <span>Calibrated model (Primary)</span>
        <div class="bar"><span class="bar-fill {{ color }}" style="width: {{ prob_pct }}%"></span></div>
        <span class="pct {{ color }}">{{ prob_pct }}%</span>
      </div>
      <div class="progress-row">
        <span>Study cohort (no recalibration)</span>
        <div class="bar"><span class="bar-fill orange" style="width: {{ p_dev_pct }}%"></span></div>
        <span class="pct orange">{{ p_dev_pct }}%</span>
      </div>
      <div class="progress-row">
        <span>Clinical-only (heuristic)</span>
        <div class="bar"><span class="bar-fill" style="width: {{ p_clinical_pct }}%"></span></div>
        <span class="pct">{{ p_clinical_pct }}%</span>
      </div>
      <p class="muted" style="margin-top:8px">
        The clinical-only estimate is a non-validated heuristic that increases with more core symptoms and WHO/CDC warning signs; it is anchored to your chosen pretest prevalence.
      </p>
      <p class="muted strong" style="margin-top:4px">Clinical-only breakdown</p>
      <ul class="ref-list">
        <li>Core features present: <strong>{{ clinical_counts.core }}/7</strong></li>
        <li>No cough / no sore throat present: <strong>{{ clinical_counts.resp_abs }}/2</strong></li>
        <li>WHO/CDC warning signs present: <strong>{{ clinical_counts.warning }}/8</strong></li>
      </ul>
    </div>
  </details>

  <div class="card">
    <h3 class="card-title">Evidence-based Estimate and Calculation</h3>
    <p class="text">
      Estimated probability of dengue (Fernández et&nbsp;al., 2016 model):
      <strong>{{ prob_pct }}%</strong>
    </p>

    <details>
      <summary><strong>Show calculation details</strong></summary>
      <div class="stack" style="margin-top:8px">
        <p class="muted">Logistic regression equation (source cited below):</p>
        <pre style="white-space:pre-wrap">y = 0.694
  + 0.718 × I(petechiae)
  + 0.516 × I(retro-ocular pain)
  + 0.316 × I(gingival bleeding)
  − 0.474 × I(epistaxis)
  − 0.535 × I(skin paleness)

p = 1 / (1 + exp(−y))</pre>

        <p class="muted">Pretest prevalence and recalibration:</p>
        <ul>
          <li>Development dataset prevalence (Fernández 2016): <strong>{{ (calc.model_info.prevalence.development_prevalence * 100) | round(1) }}%</strong></li>
          <li>Target pretest prevalence used: <strong>{{ (calc.model_info.prevalence.target_prevalence * 100) | round(1) if calc.model_info.prevalence.target_prevalence is not none else 'n/a' }}</strong> (<a href="{{ calc.model_info.prevalence.target_prevalence_source_url }}" target="_blank" rel="noopener">source</a>)</li>
          <li>Calibration offset applied to the linear predictor: <strong>{{ offset_applied | round(3) }}</strong></li>
        </ul>

        <p class="muted">Inputs detected from your selections:</p>
        <ul>
          <li>Petechiae: <strong>{{ 1 if calc.inputs.petechiae else 0 }}</strong></li>
          <li>Retro-ocular pain: <strong>{{ 1 if calc.inputs.retro_ocular_pain else 0 }}</strong></li>
          <li>Gingival bleeding: <strong>{{ 1 if calc.inputs.gingival_bleeding else 0 }}</strong></li>
          <li>Epistaxis: <strong>{{ 1 if calc.inputs.epistaxis else 0 }}</strong></li>
          <li>Skin paleness: <strong>{{ 1 if calc.inputs.skin_paleness else 0 }}</strong></li>
        </ul>

        <p class="muted">Coefficient-weighted sum (development model):</p>
        <pre style="white-space:pre-wrap">y_dev = {{ (calc.y_dev) | round(3) }}

y = y_dev + offset
offset (calibration) = {{ offset_applied | round(3) }}

y (used) = {{ (calc.y) | round(3) }}

Shown below for transparency (expanding the individual terms):
y_dev = {{ (calc.coeffs.intercept) | round(3) }}
  + {{ (calc.coeffs.petechiae) | round(3) }} × {{ calc.inputs.petechiae }}
  + {{ (calc.coeffs.retro_ocular_pain) | round(3) }} × {{ calc.inputs.retro_ocular_pain }}
  + {{ (calc.coeffs.gingival_bleeding) | round(3) }} × {{ calc.inputs.gingival_bleeding }}
  − {{ (-calc.coeffs.epistaxis) | round(3) }} × {{ calc.inputs.epistaxis }}
  − {{ (-calc.coeffs.skin_paleness) | round(3) }} × {{ calc.inputs.skin_paleness }}
  = {{ (calc.y_dev) | round(3) }}

p = 1 / (1 + exp(−y)) = {{ (calc.p) | round(3) }} ({{ prob_pct }}%)</pre>

        <p class="muted">
          Model performance reported by the source: AUC {{ (calc.model_info.auc) | round(2) }} (95% CI {{ (calc.model_info.auc_ci[0]) | round(2) }}–{{ (calc.model_info.auc_ci[1]) | round(2) }}),
          sensitivity {{ (calc.model_info.reported_sensitivity * 100) | round(1) }}%, specificity {{ (calc.model_info.reported_specificity * 100) | round(1) }}%. The study also explored a classification cut-point of {{ (calc.model_info.explored_threshold) | round(2) }} to improve specificity while maintaining sensitivity > 85%.
        </p>

        <div class="muted" style="font-size:0.9em">
          <p><strong>Important notes for transparency:</strong></p>
          <ul>
            <li>This probability is computed from a published logistic model and is not a diagnosis.</li>
            <li>If a predictor is not selected, it is treated as 0 (absent) in the equation.</li>
            <li>Clinical judgment and diagnostic testing are required to confirm dengue.</li>
          </ul>
        </div>
      </div>
    </details>

    <div class="stack" style="margin-top:12px">
      <p class="muted"><strong>Selected symptoms:</strong> {{ ", ".join(selected_symptoms or []) if selected_symptoms else "None" }}</p>
      <details>
        <summary><strong>Show sources</strong></summary>
        <div class="stack" style="margin-top:8px">
          <ul class="ref-list">
            <li>Fernández E, et al. A predictive model to differentiate dengue from other febrile illness. <a href="{{ calc.model_info.source_url }}" target="_blank" rel="noopener">{{ calc.model_info.source_url }}</a></li>
            <li>CDC. Clinical Features of Dengue. <a href="{{ calc.model_info.cdc_features_url }}" target="_blank" rel="noopener">{{ calc.model_info.cdc_features_url }}</a></li>
            {% if additional_sources %}
              {% for src in additional_sources %}
                <li>{{ src.title }} <a href="{{ src.url }}" target="_blank" rel="noopener">{{ src.url }}</a></li>
              {% endfor %}
            {% endif %}
          </ul>
        </div>
      </details>
    </div>
  </div>

  <div class="card">
    <h3 class="card-title">What's Next?</h3>
    <div class="stack">
      <a class="btn primary" href="/symptom-checker">Retake Assessment</a>
      <a class="btn outline" href="/education">Learn More About Dengue</a>
    </div>
  </div>

  <details class="card">
    <summary><span class="card-title"><strong>Combinations and Percentages</strong></span></summary>
    <div class="stack" style="margin-top:8px">
      <p class="muted">This section lists all single-symptom percentages and the top high-risk combinations computed by the enhanced assessment. All symptoms selected will always show 100%.</p>

      <div class="row between" style="gap:12px; align-items:flex-end">
        <div>
          <p class="strong">Single symptoms (highest to lowest)</p>
        </div>
        <small id="combo-meta" class="muted"></small>
      </div>

      <div class="table-wrap" style="overflow:auto">
        <table class="table" id="single-symptoms-table">
          <thead>
            <tr>
              <th style="min-width:220px">Symptom</th>
              <th>Category</th>
              <th>Weight</th>
              <th>Percentage</th>
              <th>Risk level</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <p class="strong" style="margin-top:12px">Top high-risk combinations (60%+)</p>
      <div class="table-wrap" style="overflow:auto">
        <table class="table" id="high-risk-combos-table">
          <thead>
            <tr>
              <th style="min-width:320px">Symptoms</th>
              <th>Count</th>
              <th>Percentage</th>
              <th>Risk level</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <p class="muted" id="all-symptoms-summary"></p>
    </div>

    <script>
      (function(){
        async function loadCombinations(){
          try{
            const res = await fetch('/api/symptom-combinations', { headers: { 'Accept':'application/json' } });
            if(!res.ok) throw new Error('Request failed');
            const data = await res.json();
            if(!data || !data.ok) throw new Error(data && data.error || 'Invalid response');

            const singleTbody = document.querySelector('#single-symptoms-table tbody');
            const combosTbody = document.querySelector('#high-risk-combos-table tbody');
            const meta = document.getElementById('combo-meta');
            const allSummary = document.getElementById('all-symptoms-summary');

            // Single symptoms
            singleTbody.innerHTML = '';
            (data.single_symptoms || []).forEach(row => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${row.name}</td>
                <td>${row.category}</td>
                <td>${row.weight}</td>
                <td><strong>${row.percentage}%</strong></td>
                <td>${row.risk_level.replace(/_/g,' ')}</td>
              `;
              singleTbody.appendChild(tr);
            });

            // High-risk combinations
            combosTbody.innerHTML = '';
            (data.high_risk_combinations || []).forEach(row => {
              const names = (row.symptom_names || row.symptoms || []).join(', ');
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${names}</td>
                <td>${row.count}</td>
                <td><strong>${row.percentage}%</strong></td>
                <td>${row.risk_level.replace(/_/g,' ')}</td>
              `;
              combosTbody.appendChild(tr);
            });

            // Metadata
            if(meta) meta.textContent = `Symptoms tracked: ${data.total_symptoms}`;

            // All-symptoms summary
            if(data.all_symptoms_result){
              allSummary.textContent = `All symptoms selected → ${data.all_symptoms_result.percentage}% (${data.all_symptoms_result.risk_level.replace(/_/g,' ')})`;
            }
          } catch(err){
            const singleTbody = document.querySelector('#single-symptoms-table tbody');
            const combosTbody = document.querySelector('#high-risk-combos-table tbody');
            singleTbody.innerHTML = `<tr><td colspan="5" class="danger">Failed to load: ${err && err.message ? err.message : 'Error'}</td></tr>`;
            combosTbody.innerHTML = `<tr><td colspan="4" class="danger">Failed to load.</td></tr>`;
          }
        }
        // Lazy load when user expands the details
        const details = document.currentScript && document.currentScript.closest('details');
        if(details){
          let loaded = false;
          details.addEventListener('toggle', () => {
            if(details.open && !loaded){
              loaded = true;
              loadCombinations();
            }
          });
        } else {
          // Fallback: load immediately
          loadCombinations();
        }
      })();
    </script>
  </details>

  <a class="btn linkback" href="/dashboard" style="margin-top:12px">← Back</a>
{% endblock %}
