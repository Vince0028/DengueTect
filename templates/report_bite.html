{% extends 'base.html' %}
  {% block title %}Report a Bite - DengueTect{% endblock %}
  {% block content %}
    <a class="btn linkback" href="/dashboard">‚Üê Back</a>
    <h2 class="page-title">Report a Bite</h2>

    <div class="card soft">
      <h3 class="card-title">Upload Bite Photo</h3>
      <p class="muted">Take or upload a clear photo of the suspected mosquito bite for AI analysis</p>

      <div id="dropzone" class="dropzone">
        <div class="dropzone-inner">
          <i class="bi bi-camera2 dropzone-icon"></i>
          <p class="muted">No image selected</p>
          <small class="muted">Drag & drop a photo here</small>
        </div>
        <img id="preview-img" class="dropzone-preview hidden" alt="Preview" />
        <!-- Inline camera lives inside the dropzone so no extra frame -->
        <video id="cameraVideo" class="dropzone-video hidden" autoplay playsinline muted></video>
      </div>

      <div class="stack" style="margin-top:12px">
        <input id="camera-input" class="hidden-input" type="file" accept="image/*" capture="environment" />
        <input id="gallery-input" class="hidden-input" type="file" accept="image/*" />
        <button class="btn primary full" id="btn-camera"><i class="bi bi-camera me-2"></i>Take Photo</button>
        <button class="btn outline full" id="btn-gallery"><i class="bi bi-upload me-2"></i>Upload from Gallery</button>
      </div>

      <!-- Controls shown only while camera is active -->
      <div id="camera-controls" class="row gap hidden" style="margin-top:12px">
        <button type="button" class="btn outline" id="btn-cancel-camera">Cancel</button>
        <button type="button" class="btn primary" id="btn-capture"><i class="bi bi-camera me-2"></i>Capture</button>
      </div>

      <div id="actions" class="row gap hidden" style="margin-top:12px">
        <button class="btn outline" id="btn-retake">Retake</button>
        <a class="btn primary" href="/bite-analysis-result" id="btn-analyze">Analyze Bite</a>
      </div>
    </div>

    <div class="card soft">
      <h3 class="card-title">Tips for Best Results</h3>
      <ul class="list small">
        <li>Ensure good lighting</li>
        <li>Keep the bite in focus</li>
        <li>Include surrounding skin for context</li>
        <li>Avoid blurry or dark images</li>
      </ul>
    </div>

    <script>
      const dz = document.getElementById('dropzone');
      const previewImg = document.getElementById('preview-img');
      const cameraInput = document.getElementById('camera-input');
      const galleryInput = document.getElementById('gallery-input');
      const btnCamera = document.getElementById('btn-camera');
      const btnGallery = document.getElementById('btn-gallery');
      const btnRetake = document.getElementById('btn-retake');
      const actions = document.getElementById('actions');
      const cameraVideo = document.getElementById('cameraVideo');
      const btnCapture = document.getElementById('btn-capture');
      const btnCancelCamera = document.getElementById('btn-cancel-camera');
      const cameraControls = document.getElementById('camera-controls');
      let mediaStream = null;
      function setStreamingUI(on){
        if (btnCamera) btnCamera.disabled = on;
        if (btnGallery) btnGallery.disabled = on;
        if (btnCapture) btnCapture.disabled = !on;
        if (btnCancelCamera) btnCancelCamera.disabled = !on;
      }

      function handleFile(file){
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev)=>{
          previewImg.src = ev.target.result;
          previewImg.classList.remove('hidden');
          dz.classList.add('has-image');
          actions.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }

      async function openCamera(){
        try{
          // Immediately pause background and lock UI while we init camera
          try { if (window.__vantaDestroy) window.__vantaDestroy(); } catch(e){}
          setStreamingUI(true);
          if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
            // Fallback to input with capture attr (mobile)
            cameraInput.click();
            setStreamingUI(false);
            return;
          }
          // Lower resolution and frame rate to reduce GPU/CPU load
          const constraints = {
            video: {
              facingMode: { ideal: 'environment' },
              width: { ideal: 960, max: 1280 },
              height: { ideal: 540, max: 720 },
              frameRate: { ideal: 15, max: 24 }
            },
            audio: false
          };
          mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
          cameraVideo.srcObject = mediaStream;
          try { cameraVideo.play(); } catch(e){}
          // Show camera inline inside dropzone
          if (cameraVideo) cameraVideo.classList.remove('hidden');
          if (dz) dz.classList.add('camera-on');
          if (cameraControls) cameraControls.classList.remove('hidden');
          // UI stays in streaming state
        }catch(err){
          // Permission denied or no camera => fallback
          try { cameraInput.click(); } catch(e){}
          setStreamingUI(false);
          // Resume background if we failed to open camera
          try { if (window.__vantaInit) setTimeout(()=>window.__vantaInit(), 50); } catch(e){}
        }
      }

      function stopStream(){
        if(mediaStream){
          mediaStream.getTracks().forEach(t=>t.stop());
          mediaStream = null;
        }
        setStreamingUI(false);
      }

      btnCamera.addEventListener('click',(e)=>{e.preventDefault(); openCamera();});
      btnGallery.addEventListener('click',(e)=>{e.preventDefault(); galleryInput.click();});

      cameraInput.addEventListener('change',(e)=>handleFile(e.target.files && e.target.files[0]));
      galleryInput.addEventListener('change',(e)=>handleFile(e.target.files && e.target.files[0]));

      // Capture from live camera
      if (btnCapture){
        btnCapture.addEventListener('click',()=>{
          if(!mediaStream) return;
          const trackSettings = mediaStream.getVideoTracks()[0].getSettings();
          let w = trackSettings.width || 640;
          let h = trackSettings.height || 480;
          // Limit captured size for performance
          const maxW = 960;
          if (w > maxW) {
            const ratio = w / h;
            w = maxW; h = Math.round(maxW / ratio);
          }
          const canvas = document.createElement('canvas');
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(cameraVideo, 0, 0, w, h);
          canvas.toBlob((blob)=>{
            if(!blob) return;
            handleFile(new File([blob], 'capture.jpg', { type: 'image/jpeg' }));
            stopStream();
            // Hide camera element, show dropzone preview
            if (cameraVideo) cameraVideo.classList.add('hidden');
            if (dz) dz.classList.remove('camera-on');
            if (cameraControls) cameraControls.classList.add('hidden');
            // Resume background animation after closing
            try { if (window.__vantaInit) setTimeout(()=>window.__vantaInit(), 50); } catch(e){}
          }, 'image/jpeg', 0.92);
        });
      }

      // Cancel inline camera
      if (btnCancelCamera){
        btnCancelCamera.addEventListener('click', (e)=>{
          e.preventDefault();
          stopStream();
          if (cameraVideo) cameraVideo.classList.add('hidden');
          if (dz) dz.classList.remove('camera-on');
          if (cameraControls) cameraControls.classList.add('hidden');
          try { if (window.__vantaInit) setTimeout(()=>window.__vantaInit(), 50); } catch(e){}
        });
      }

      dz.addEventListener('dragover',(e)=>{e.preventDefault(); dz.classList.add('drag');});
      dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
      dz.addEventListener('drop',(e)=>{
        e.preventDefault(); dz.classList.remove('drag');
        const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
        handleFile(f);
      });

      btnRetake.addEventListener('click',(e)=>{
        e.preventDefault();
        previewImg.src='';
        previewImg.classList.add('hidden');
        dz.classList.remove('has-image');
        actions.classList.add('hidden');
        cameraInput.value=''; galleryInput.value='';
      });
    </script>
  {% endblock %}
