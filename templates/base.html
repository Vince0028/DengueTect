<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{% block title %}DengueTect{% endblock %}</title>
    <script>
      (function () {
        function getCookie(name){
          try {
            return document.cookie.split('; ').find(row=>row.startsWith(name+'='))?.split('=')[1] || '';
          } catch(e){ return ''; }
        }
        try {
          var cookieTheme = getCookie('theme');
          var stored = localStorage.getItem('theme');
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          var theme = cookieTheme || stored || (prefersDark ? 'dark' : 'light');
          document.documentElement.setAttribute('data-theme', theme);
        } catch (e) {}
      })();
    </script>
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}?v=4">
  </head>
  <body>
    {% if not hide_nav %}
    <div id="vanta-bg"></div>
    {% endif %}
    <header class="app-header">
      <div class="container header-inner">
        <div class="brand">
          <img src="/images/dengue-logo.png" alt="DengueTect" class="brand-logo" />
          <div>
            <div class="brand-title">DengueTect</div>
            <div class="brand-sub">Health Monitoring</div>
          </div>
        </div>
        {% if not hide_nav %}
          <div class="header-right">
            <button class="menu-toggle" id="menuToggle" aria-label="Toggle navigation"><i class="bi bi-list"></i></button>
            <nav class="app-nav" id="mainNav">
              <a href="/dashboard"><i class="bi bi-speedometer2 ico"></i><span>Dashboard</span></a>
              <a href="/education"><i class="bi bi-journal-text ico"></i><span>Education</span></a>
              {% if not logged_in %}
                <a href="/"><i class="bi bi-shield-lock ico"></i><span>Sign in</span></a>
              {% endif %}
            </nav>
            <div id="reactActions" class="d-flex align-items-center" data-logged-in="{{ 'true' if logged_in else 'false' }}"></div>
            <div id="actionsFallback" class="d-flex align-items-center gap-2">
              {% if logged_in %}
              <div class="dropdown">
                <button class="btn btn-light rounded-circle avatar-btn" data-bs-toggle="dropdown" aria-expanded="false">
                  <img src="/placeholder-logo.png" alt="Profile" class="avatar-img" />
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                  <li><a class="dropdown-item" href="/profile"><i class="bi bi-person me-2"></i>Profile</a></li>
                  <li><a class="dropdown-item" href="/settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
                  <li><hr class="dropdown-divider"/></li>
                  <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Log out</a></li>
                </ul>
              </div>
              {% else %}
              <a class="btn btn-outline-light" href="/"><i class="bi bi-shield-lock me-2"></i>Sign in</a>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </div>
    </header>

    <main class="container">
      {% block content %}{% endblock %}
    </main>

    <footer class="footer">
      <div class="container">
        <small>&copy; {{ current_year }} DengueTect</small>
      </div>
    </footer>
    <script>
      (function () {
        var nav = document.getElementById('mainNav');
        var menuToggle = document.getElementById('menuToggle');
        if (menuToggle && nav) {
          menuToggle.addEventListener('click', function () {
            nav.classList.toggle('open');
          });
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    {% if not hide_nav %}
    <!-- Vanta waves background (global on all pages except login) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
    <script>
      (function(){
        var vInst;
        var tries = 0;
        function getVantaColor(){
          try {
            var theme = document.documentElement.getAttribute('data-theme') || 'light';
            return theme === 'dark' ? 0x064e3b : 0x16a34a; // darker green in dark mode
          } catch(e){ return 0x16a34a; }
        }
        function create(){
          if (!window.VANTA || !window.THREE) return false;
          if (vInst && vInst.destroy) { try { vInst.destroy(); } catch(e){} }
          vInst = VANTA.WAVES({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            color: getVantaColor(),
            shininess: 35.00,
            waveHeight: 20.00,
            waveSpeed: 0.80,
            zoom: 0.90,
            scale: 1.00,
            scaleMobile: 1.00
          });
          window.__vanta__ = vInst;
          window.__vantaRunning = true;
          return true;
        }
        function tryInit(){
          var ok = create();
          if (!ok && tries < 30){ tries++; setTimeout(tryInit, 100); }
        }
        function destroy(){
          if (vInst && vInst.destroy){ try { vInst.destroy(); } catch (e) {} }
          vInst = null; window.__vanta__ = null; window.__vantaRunning = false;
        }
        // React to theme changes (light <-> dark)
        try {
          var mo = new MutationObserver(function(muts){
            for (var i=0;i<muts.length;i++){
              var m = muts[i];
              if (m.type === 'attributes' && m.attributeName === 'data-theme'){
                destroy();
                setTimeout(tryInit, 10);
              }
            }
          });
          mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
        } catch(e) {}
        window.__vantaInit = tryInit;
        window.__vantaDestroy = destroy;
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', tryInit);
        else tryInit();
        window.addEventListener('load', tryInit);
        window.addEventListener('beforeunload', destroy);
      })();
    </script>
    {% endif %}
    <script type="text/babel" data-presets="env,react">
      const { useEffect, useState } = React;
      function ThemeToggle(){
        const initial = (function(){
          try { return localStorage.getItem('theme') || document.documentElement.getAttribute('data-theme') || 'light'; } catch(e) { return document.documentElement.getAttribute('data-theme') || 'light'; }
        })();
        const [theme, setTheme] = useState(initial);
        useEffect(() => {
          document.documentElement.setAttribute('data-theme', theme);
          try { localStorage.setItem('theme', theme); } catch(e) {}
          try { document.cookie = 'theme=' + theme + '; path=/; max-age=31536000'; } catch(e) {}
        }, [theme]);
        useEffect(() => {
          function onStorage(e){
            if(e.key === 'theme' && e.newValue){
              document.documentElement.setAttribute('data-theme', e.newValue);
              if (e.newValue !== theme) setTheme(e.newValue);
            }
          }
          window.addEventListener('storage', onStorage);
          return () => window.removeEventListener('storage', onStorage);
        }, [theme]);
        return (
          <button className="theme-toggle" aria-label="Toggle dark mode" onClick={() => setTheme(theme === 'dark' ? 'light' : 'dark')}>
            {theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'}
          </button>
        );
      }
      function ProfileMenu({ loggedIn }){
        return (
          <div className="dropdown">
            <button className="btn btn-light rounded-circle avatar-btn" data-bs-toggle="dropdown" aria-expanded="false">
              <img src="/placeholder-logo.png" alt="Profile" className="avatar-img" />
            </button>
            <ul className="dropdown-menu dropdown-menu-end shadow">
              {loggedIn ? (
                <>
                  <li><a className="dropdown-item" href="/profile"><i className="bi bi-person me-2"></i>Profile</a></li>
                  <li><a className="dropdown-item" href="/settings"><i className="bi bi-gear me-2"></i>Settings</a></li>
                  <li><hr className="dropdown-divider"/></li>
                  <li><a className="dropdown-item text-danger" href="/logout"><i className="bi bi-box-arrow-right me-2"></i>Log out</a></li>
                </>
              ) : (
                <>
                  <li><a className="dropdown-item" href="/"><i className="bi bi-shield-lock me-2"></i>Sign in</a></li>
                </>
              )}
            </ul>
          </div>
        );
      }
      function Actions({ loggedIn }){
        return (
          <div className="d-flex align-items-center gap-2">
            <ThemeToggle />
            <ProfileMenu loggedIn={loggedIn} />
          </div>
        );
      }
      window.addEventListener('DOMContentLoaded', function(){
        const mount = document.getElementById('reactActions');
        if (mount) {
          const loggedIn = (mount.dataset.loggedIn || 'false') === 'true';
          ReactDOM.createRoot(mount).render(<Actions loggedIn={loggedIn} />);
          // Remove fallback only if React actually rendered something
          setTimeout(function(){
            var fb = document.getElementById('actionsFallback');
            if (fb && mount && mount.firstElementChild) { fb.remove(); }
          }, 80);
        }
      });
    </script>
  </body>
</html>
