{% extends 'base.html' %}
{% block title %}Login - DengueTect{% endblock %}
{% block content %}
  <div id="vanta-bg"></div>
  <div class="card center glass">
    <div class="text-center">
      <div class="logo-box"><img src="/images/dengue-logo.png" alt="DengueTect Logo" class="logo-img" /></div>
      <h1>DengueTect</h1>
      <p class="muted">AI-Powered Dengue Pre-Screening</p>
    </div>

    {% if request.args.get('error') == 'invalid' %}
      <div class="card warning" style="text-align:left">Invalid email or password.</div>
    {% endif %}

    <form action="/login" method="post" class="form">
      <label>Email</label>
      <input type="email" name="email" value="{{ request.args.get('email','') }}" placeholder="Enter your email" required />

      <label>Password</label>
      <input type="password" name="password" placeholder="Enter your password" required />

      <button type="submit" class="btn primary full">Sign In</button>
    </form>

    <div class="stack" style="margin-top:8px">
      <a class="btn outline full" href="/register?email={{ request.args.get('email','') }}">Create an account</a>
      <div class="divider">Or continue as</div>
      <a class="btn outline full" href="/dashboard">Guest Mode</a>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.cells.min.js"></script>
  <script>
    (function(){
      var vInst;
      function themeColors(){
        var theme = document.documentElement.getAttribute('data-theme') || 'light';
        // Light theme greens, dark theme deeper greens
        return theme === 'dark' ? { c1: 0x064e3b, c2: 0x22c55e } : { c1: 0x16a34a, c2: 0x4ade80 };
      }
      function fromHex(str){ try { return parseInt(str.replace('#',''), 16); } catch(e){ return null; } }
      function toHex(n){ try { return '#' + (n >>> 0).toString(16).padStart(6,'0'); } catch(e){ return '#16a34a'; } }
      function readCfg(){
        var t = themeColors();
        try{
          var c1 = localStorage.getItem('v_cells_c1');
          var c2 = localStorage.getItem('v_cells_c2');
          var size = parseFloat(localStorage.getItem('v_cells_size'));
          var speed = parseFloat(localStorage.getItem('v_cells_speed'));
          return {
            c1: c1 ? fromHex(c1) : t.c1,
            c2: c2 ? fromHex(c2) : t.c2,
            size: Number.isFinite(size) ? size : 1.2,
            speed: Number.isFinite(speed) ? speed : 1.2
          };
        } catch(e){ return { c1: t.c1, c2: t.c2, size: 1.2, speed: 1.2 }; }
      }
      function init(){
        if (!window.VANTA || !window.THREE) return false;
        try { if (vInst && vInst.destroy) vInst.destroy(); } catch(e){}
        var cs = readCfg();
        vInst = VANTA.CELLS({
          el: "#vanta-bg",
          mouseControls: true,
          touchControls: true,
          gyroControls: false,
          minHeight: 200.00,
          minWidth: 200.00,
          scale: 1.00,
          color1: cs.c1,
          color2: cs.c2,
          size: cs.size,
          speed: cs.speed
        });
        return true;
      }
      function tryInit(){ if (!init()) setTimeout(tryInit, 100); }
      // Recreate when theme changes
      try{
        var mo = new MutationObserver(function(muts){
          for (var i=0;i<muts.length;i++){
            if (muts[i].type === 'attributes' && muts[i].attributeName === 'data-theme'){
              try { if (vInst && vInst.destroy) vInst.destroy(); } catch(e){}
              setTimeout(tryInit, 30);
            }
          }
        });
        mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
      } catch(e){}
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', tryInit);
      else tryInit();
      window.addEventListener('beforeunload', function(){ try { if (vInst && vInst.destroy) vInst.destroy(); } catch(e){} });
    })();
  </script>
{% endblock %}
